<?php

class Policyjny_Glos_Mazowsza extends Journal {
  public static $compressed_links = [
    'http://www.mazowiecka.policja.gov.pl/download/271/165/2000.rar' => '2000.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/166/2001.rar' => '2001.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/167/2002.rar' => '2002.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/168/2003.rar' => '2003.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/169/2004.rar' => '2004.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/170/2005.rar' => '2005.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/171/2006.rar' => '2006.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/172/2007.rar' => '2007.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/173/2008.rar' => '2008.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/174/2009.rar' => '2009.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/175/2010.rar' => '2010.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/176/2011.rar' => '2011.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/177/2012.rar' => '2012.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/178/2013.rar' => '2013.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/179/2014.rar' => '2014.rar',
    'http://www.mazowiecka.policja.gov.pl/download/271/181/2015.rar' => '2016.rar',
  ];

  public static $links = [
    'nr_01 2000.pdf' => [2000,'1'],
    'nr_02 2000.pdf' => [2000,'2'],
    'nr_03 2000.pdf' => [2000,'3'],
    'nr_04 2000.pdf' => [2000,'4'],
    'nr_05 2001.pdf' => [2001,'5'],
    'nr_06 2001.pdf' => [2001,'6'],
    'nr_07 2001.pdf' => [2001,'7'],
    'nr_08 2001.pdf' => [2001,'8'],
    'nr_09 2001.pdf' => [2001,'9'],
    'nr_10 2001.pdf' => [2001,'10'],
    'nr_11_12 2001.pdf' => [2001,'11-12'],
    'nr_13 2001.pdf' => [2001,'13'],
    'nr_14 2001.pdf' => [2001,'14'],
    'nr_15 2001.pdf' => [2001,'15'],
    'nr_16 2001.pdf' => [2001,'16'],
    'nr_17.pdf' => [2002,'17'],
    'nr_18.pdf' => [2002,'18'],
    'nr_19.pdf' => [2002,'19'],
    'nr_20.pdf' => [2002,'20'],
    'nr_21.pdf' => [2002,'21'],
    'nr_22.pdf' => [2002,'22'],
    'nr_23.pdf' => [2002,'23'],
    'nr_24.pdf' => [2002,'24'],
    'nr_25.pdf' => [2002,'25'],
    'nr_26.pdf' => [2002,'26'],
    'nr_27.pdf' => [2002,'27'],
    'nr_28.pdf' => [2003,'28'],
    'nr_29.pdf' => [2003,'29'],
    'nr_30.pdf' => [2003,'30'],
    'nr_31.pdf' => [2003,'31'],
    'nr_32.pdf' => [2003,'32'],
    'nr_33.pdf' => [2003,'33'],
    'nr_34.pdf' => [2003,'34'],
    'nr_35.pdf' => [2003,'35'],
    'nr_36.pdf' => [2003,'36'],
    'nr_37.pdf' => [2003,'37'],
    'nr_38.pdf' => [2004,'38'],
    'nr_39.pdf' => [2004,'39'],
    'nr_40.pdf' => [2004,'40'],
    'nr_41.pdf' => [2004,'41'],
    'nr_42.pdf' => [2004,'42'],
    'nr_43.pdf' => [2004,'43'],
    'nr_44.pdf' => [2004,'44'],
    'nr_45.pdf' => [2004,'45'],
    'nr_46.pdf' => [2004,'46'],
    'nr_47.pdf' => [2004,'47'],
    'nr_48.pdf' => [2005,'48'],
    'nr_49.pdf' => [2005,'49'],
    'nr_50.pdf' => [2005,'50'],
    'nr_51.pdf' => [2005,'51'],
    'nr_52.pdf' => [2005,'52'],
    'nr_53.pdf' => [2005,'53'],
    'nr_54.pdf' => [2005,'54'],
    'nr_55.pdf' => [2005,'55'],
    'nr_56.pdf' => [2005,'56'],
    'nr_57.pdf' => [2006,'57'],
    'nr_58.pdf' => [2006,'58'],
    'nr_59.pdf' => [2006,'59'],
    'nr_60.pdf' => [2006,'60'],
    'nr_61.pdf' => [2006,'61'],
    'nr_62.pdf' => [2006,'62'],
    'nr_63.pdf' => [2006,'63'],
    'nr_64.pdf' => [2006,'64'],
    'nr_65.pdf' => [2006,'65'],
    'nr_66.pdf' => [2007,'66'],
    'nr_67.pdf' => [2007,'67'],
    'nr_68.pdf' => [2007,'68'],
    'nr_69.pdf' => [2007,'69'],
    'nr_70.pdf' => [2007,'70'],
    'nr_71.pdf' => [2007,'71'],
    'nr_72.pdf' => [2007,'72'],
    'nr_73.pdf' => [2007,'73'],
    'nr_74.pdf' => [2007,'74'],
    'nr_75.pdf' => [2008,'75'],
    'nr_76.pdf' => [2008,'76'],
    'nr_77.pdf' => [2008,'77'],
    'nr_78.pdf' => [2008,'78'],
    'PGM Nr 100_100.pdf' => [2011,'100'],
    'PGM Nr 101.pdf' => [2011,'101'],
    'PGM Nr 102.pdf' => [2011,'102'],
    'PGM Nr 103.pdf' => [2012,'103'],
    'PGM Nr 104.pdf' => [2012,'104'],
    'pgm nr 105.pdf' => [2012,'105'],
    'PGM Nr 106.pdf' => [2012,'106'],
    'PGM Nr 107.pdf' => [2012,'107'],
    'PGM Nr 108.pdf' => [2012,'108'],
    'PGM Nr 109.pdf' => [2013,'109'],
    'PGM Nr 110.pdf' => [2013,'110'],
    'PGM Nr 111.pdf' => [2013,'111'],
    'PGM Nr 112.pdf' => [2013,'112'],
    'PGM Nr 113.pdf' => [2013,'113'],
    'PGM Nr 114.pdf' => [2013,'114'],
    'PGM Nr 115 (2).pdf' => [2014,'115'],
    'PGM Nr 116.pdf' => [2014,'116'],
    'PGM Nr 117.pdf' => [2014,'117'],
    'PGM Nr 118.pdf' => [2014,'118'],
    'PGM Nr 119.pdf' => [2014,'119'],
    'PGM Nr 120.pdf' => [2014,'120'],
    'PGM Nr 121.pdf' => [2015,'121'],
    'PGM Nr 122.pdf' => [2015,'122'],
    'PGM Nr 123.pdf' => [2015,'123'],
    'PGM Nr 124.pdf' => [2015,'124'],
    'PGM Nr 125.pdf' => [2015,'125'],
    'PGM Nr 126 (1).pdf' => [2015,'126'],
    'PGM Nr 85_m.pdf' => [2009,'85'],
    'PGM Nr 86_internet.pdf' => [2009,'86'],
    'PGM Nr 87_m.pdf' => [2009,'87'],
    'PGM Nr 89.pdf' => [2009,'89'],
    'PGM Nr 90.pdf' => [2009,'90'],
    'PGM Nr 91.pdf' => [2010,'91'],
    'PGM Nr 92.pdf' => [2010,'92'],
    'PGM Nr 93.pdf' => [2010,'93'],
    'PGM Nr 94.pdf' => [2010,'94'],
    'PGM Nr 95.pdf' => [2010,'95'],
    'PGM Nr 96.pdf' => [2010,'96'],
    'PGM Nr 97.pdf' => [2011,'97'],
    'PGM Nr 98.pdf' => [2011,'98'],
    'PGM Nr 99.pdf' => [2011,'99'],
    'PGM_79.pdf' => [2008,'79'],
    'PGM_80.pdf' => [2008,'80'],
    'PGM_81internet.pdf' => [2008,'81'],
    'PGM_82.pdf' => [2008,'82'],
    'PGM_83.pdf' => [2008,'83'],
    'PGM_84.pdf' => [2009,'84'],
    'PGM_88_wrd.pdf' => [2009,'88'],
  ];

  public static function get_title() {
    return "Policyjny Głos Mazowsza";
  }

  public static function get_collection() {
    foreach(self::$links as $url => $metadata) {
      $year = $metadata[0];
      $issue = $metadata[1];
      yield [$url, self::get_title() . " - $year nr $issue"];
    }
  }

  public static function download_collection($OCR = false) {
    global $enabled_unrar;
    if ($enabled_unrar === false) {
      echo "\nPomijam kolekcję \"" . static::get_title() . "\" bo wyłączona opcja UNRAR\n";
    }
    $download_count = 0;
    echo "\nPrzetwarzam kolekcję \"" . static::get_title() . "\"\n";

    $subfolder  = static::get_title();
    $collection = static::get_collection();

    // create directory structure
    static::create_dir("Download/$subfolder");
    if ($OCR) {
      static::create_dir("OCR/$subfolder");
    }

    $temp_dir = sys_get_temp_dir();
    foreach (self::$compressed_links as $compressed_url => $compressed_file) {
      $compressed_file_path = "$temp_dir/$compressed_file";
      if (file_exists($compressed_file_path) === false) {
        if (static::download_file($compressed_url, $compressed_file_path)) {
          $download_count++;
          static::unrar($compressed_file_path);
        }
      } else {
        echo '.';
      }
    }

    foreach ($collection as $issue) {
      $url      = $issue[0];
      $title    = $issue[1];
      $file     = "Download/$subfolder/$title.pdf";
      $file_OCR = "OCR/$subfolder/$title (OCR).pdf";

      if (file_exists($file) === false) {
        $base = dirname(__FILE__);
        rename($url, $file);
      } else {
        echo '.';
        //echo "Pomijam $file\n";
      }

      if ($OCR) {
        if (file_exists($file) && file_exists($file_OCR) === false) {
          echo "Rozpoznawanie znaków do pliku $file_OCR\n";
          ocr($file, $file_OCR, $title);
        } else {
          echo '.';
          //echo "Pomijam rozpoznawanie znaków do $file_OCR\n";
        }
      }
    }

    return $download_count;
  }
}
